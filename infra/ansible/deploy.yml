---
- name: Deploy MediFind Application
  hosts: webservers
  become: yes
  vars:
    project_root: /home/ubuntu/medifind
  
  tasks:
    # Skip Docker installation - already installed
    # Just ensure Docker is running
    - name: Ensure Docker service is running
      systemd:
        name: docker
        state: started
        enabled: yes
      ignore_errors: yes


    - name: Create project directory
      file:
        path: "{{ project_root }}"
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    - name: Copy docker-compose.yml
      copy:
        src: ../../docker-compose.yml
        dest: "{{ project_root }}/docker-compose.yml"
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    - name: Log in to Docker Hub (Shell)
      shell: "echo $DOCKER_HUB_PASSWORD | docker login -u $DOCKER_HUB_USERNAME --password-stdin"
      environment:
        DOCKER_HUB_USERNAME: "{{ lookup('env', 'DOCKER_HUB_USERNAME') }}"
        DOCKER_HUB_PASSWORD: "{{ lookup('env', 'DOCKER_HUB_PASSWORD') }}"
      ignore_errors: yes

    - name: Pull latest images
      shell: docker-compose pull
      args:
        chdir: "{{ project_root }}"

    - name: Start containers
      shell: docker-compose up -d
      args:
        chdir: "{{ project_root }}"
